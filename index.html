<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>êµí•™íŒ€ ë¬¸ì˜ ì±—ë´‡</title>
    <!-- ğŸ“ ì´ëª¨ì§€ íŒŒë¹„ì½˜ -->
    <link rel="icon" href="data:image/svg+xml,
    <svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'>
      <text y='0.9em' x='0.5em' text-anchor='middle' font-size='80'>ğŸ“</text>
    </svg>">
    
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --primary-light: #3b82f6;
            --bg-gray: #f3f4f6;
            --text-dark: #1f2937;
            --text-gray: #6b7280;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 25px rgba(0,0,0,0.15);
            --transition-fast: 0.15s;
            --transition-normal: 0.3s;
            --transition-slow: 0.5s;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .chat-container {
            max-width: 640px;
            width: 100%;
            height: 85vh;
            background: white;
            border-radius: 24px;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transform: translateY(0);
            transition: transform var(--transition-normal), box-shadow var(--transition-normal);
        }

        .chat-container:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }

        .chat-header {
            padding: 24px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .chat-header h1 { font-size: 1.25rem; font-weight: 700; position: relative; }
        .chat-header p { font-size: 0.875rem; opacity: 0.9; margin-top: 4px; position: relative; }

        .status-indicator { display: inline-flex; align-items: center; gap: 6px; margin-top: 8px; font-size: 0.75rem; opacity: 0.9; }
        .status-dot { width: 8px; height: 8px; background: #4ade80; border-radius: 50%; box-shadow: 0 0 0 2px rgba(74, 222, 128, 0.3), 0 0 8px rgba(74, 222, 128, 0.5); animation: pulse 2s infinite; }

        @keyframes pulse { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.2); opacity: 0.8; } }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            background: var(--bg-gray);
            scroll-behavior: smooth;
        }

        .message {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 16px;
            line-height: 1.6;
            position: relative;
            animation: messageIn 0.3s ease-out;
            will-change: transform, opacity;
            transition: transform var(--transition-fast);
            /* ì¤„ë°”ê¿ˆ(\n) ì ìš© í•µì‹¬ ì„¤ì • */
            white-space: pre-wrap;
            word-break: break-all;
        }

        @keyframes messageIn { from { opacity: 0; transform: translateY(10px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }

        .message.user { align-self: flex-end; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; border-bottom-right-radius: 4px; }
        .message.bot { align-self: flex-start; background: white; color: var(--text-dark); border-bottom-left-radius: 4px; box-shadow: var(--shadow-sm); }

        .response-type { display: inline-flex; align-items: center; gap: 4px; font-size: 0.7rem; font-weight: 600; padding: 4px 10px; border-radius: 20px; margin-bottom: 8px; backdrop-filter: blur(4px); }
        .response-type.direct { background: rgba(34, 197, 94, 0.15); color: #16a34a; border: 1px solid rgba(34, 197, 94, 0.3); }
        .response-type.conditional { background: rgba(245, 158, 11, 0.15); color: #d97706; border: 1px solid rgba(245, 158, 11, 0.3); }
        .response-type.human_handoff { background: rgba(239, 68, 68, 0.15); color: #dc2626; border: 1px solid rgba(239, 68, 68, 0.3); }

        .cited-regulations { margin-top: 12px; padding-top: 12px; border-top: 1px dashed #e5e7eb; font-size: 0.85rem; }
        .cited-regulations summary { cursor: pointer; color: var(--text-gray); padding: 8px 12px; background: var(--bg-gray); border-radius: 8px; list-style: none; }
        .cited-regulations summary::before { content: 'â–¶'; display: inline-block; margin-right: 8px; font-size: 0.7rem; transition: transform var(--transition-fast); }
        .cited-regulations details[open] summary::before { transform: rotate(90deg); }
        .cited-regulations ul { margin-top: 8px; list-style: none; }
        .cited-regulations li { padding: 8px 12px; margin: 4px 0; background: var(--bg-gray); border-radius: 6px; color: var(--text-gray); font-size: 0.8rem; }

        .loading { display: flex; align-items: center; gap: 6px; padding: 16px 20px; background: white; border-radius: 16px; align-self: flex-start; }
        .loading span { width: 10px; height: 10px; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); border-radius: 50%; animation: bounce 1.4s infinite ease-in-out; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0.6); opacity: 0.5; } 40% { transform: scale(1); opacity: 1; } }

        .chat-input { padding: 16px 20px; background: white; border-top: 1px solid #e5e7eb; display: flex; gap: 12px; align-items: center; }
        .input-wrapper { flex: 1; }
        .input-wrapper textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 16px;
            outline: none;
            background: var(--bg-gray);
            transition: all var(--transition-fast);
            resize: none;
            min-height: 44px;
            max-height: 120px;
            font-family: inherit;
            font-size: 0.95rem;
        }
        .input-wrapper textarea:focus {
            border-color: var(--primary);
            background: white;
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
        }

        .send-button { width: 48px; height: 48px; border: none; border-radius: 50%; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); transition: all var(--transition-fast); }
        .send-button:hover { transform: scale(1.08); }
        .send-button svg { width: 20px; height: 20px; }

        @media (max-width: 480px) { body { padding: 0; } .chat-container { height: 100vh; border-radius: 0; } }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <h1>ğŸ“ êµí•™íŒ€ ë¬¸ì˜ ì±—ë´‡</h1>
            <p>íœ´í•™, ë³µí•™, ìˆ˜ê°•ì‹ ì²­ ë“± í•™ì‚¬ ê´€ë ¨ ì§ˆë¬¸ì— ë‹µë³€í•´ë“œë¦½ë‹ˆë‹¤</p>
            <div class="status-indicator">
                <span class="status-dot"></span>
                <span>ì˜¨ë¼ì¸</span>
            </div>
        </div>
        
        <div class="chat-messages" id="chatMessages">
            <div class="message bot">ì•ˆë…•í•˜ì„¸ìš”! êµí•™íŒ€ ë¬¸ì˜ ì±—ë´‡ì…ë‹ˆë‹¤. ğŸ™‹â€â™‚ï¸<br>í•™ì‚¬ ê´€ë ¨ ê¶ê¸ˆí•œ ì ì„ ì§ˆë¬¸í•´ì£¼ì„¸ìš”.</div>
        </div>

        <div class="chat-input">
            <div class="input-wrapper">
                <textarea id="userInput" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
            </div>
            <button class="send-button" id="sendButton" onclick="sendMessage()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                </svg>
            </button>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8000';
        const chatMessages = document.getElementById('chatMessages');
        const userInput = document.getElementById('userInput');
        const sendButton = document.getElementById('sendButton');
        
        // Enter: ì „ì†¡, Shift+Enter: ì¤„ë°”ê¿ˆ
        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                if (e.shiftKey) {
                    // ì¤„ë°”ê¿ˆì€ ê¸°ë³¸ ë™ì‘ ìœ ì§€
                    return;
                }
                e.preventDefault();
                sendMessage();
            }
        });

        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;
            
            userInput.value = '';
            sendButton.disabled = true;
            
            addMessage(message, 'user');
            const loadingElement = addLoading();
            
            try {
                const response = await fetch(`${API_URL}/query`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question: message }),
                });
                
                if (!response.ok) throw new Error('ì„œë²„ ì˜¤ë¥˜');
                const data = await response.json();
                loadingElement.remove();
                addBotMessage(data);
                
            } catch (error) {
                loadingElement.remove();
                addMessage('ì£„ì†¡í•©ë‹ˆë‹¤. ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'bot', true);
            } finally {
                sendButton.disabled = false;
                userInput.focus();
            }
        }
        
        function addMessage(content, type, isError = false) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', type);
            if (isError) messageDiv.classList.add('error');
            messageDiv.textContent = content;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return messageDiv;
        }
        
        function addBotMessage(data) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', 'bot');
            
            let html = '';
            if (data.response_type) {
                const typeConfig = {
                    'direct': { icon: 'âœ…', label: 'ì§ì ‘ ë‹µë³€' },
                    'conditional': { icon: 'âš ï¸', label: 'ì¡°ê±´ë¶€ ë‹µë³€' },
                    'human_handoff': { icon: 'ğŸ“', label: 'ìƒë‹´ í•„ìš”' }
                };
                const config = typeConfig[data.response_type] || { icon: 'ğŸ’¬', label: data.response_type };
                html += `<span class="response-type ${data.response_type}">${config.icon} ${config.label}</span><br>`;
            }
            
            // ë‹µë³€ í…ìŠ¤íŠ¸ ì¶”ê°€
            const mainAnswer = data.answer || data.message || 'ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.';
            html += `<div class="answer-text">${mainAnswer}</div>`;
            
            if (data.cited_regulations?.length > 0) {
                html += `
                    <div class="cited-regulations">
                        <details>
                            <summary>ğŸ“š ì°¸ê³  ê·œì • (${data.cited_regulations.length}ê°œ)</summary>
                            <ul>${data.cited_regulations.map(reg => `<li>${reg}</li>`).join('')}</ul>
                        </details>
                    </div>`;
            }
            
            messageDiv.innerHTML = html;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function addLoading() {
            const loadingDiv = document.createElement('div');
            loadingDiv.classList.add('loading');
            loadingDiv.innerHTML = '<span></span><span></span><span></span>';
            chatMessages.appendChild(loadingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return loadingDiv;
        }
        
        async function checkServerStatus() {
            try {
                await fetch(`${API_URL}/health`);
            } catch (error) {
                addMessage('âš ï¸ ì„œë²„ ì—°ê²°ì´ ì›í™œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'bot', true);
            }
        }
        checkServerStatus();
    </script>
</body>
</html>